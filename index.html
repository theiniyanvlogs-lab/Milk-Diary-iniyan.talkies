<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Milk Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{font-family:Arial;margin:0;background:#f5f5f5}
.center{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.box{background:#fff;padding:20px;border-radius:8px;width:100%;max-width:420px;text-align:center}
.header{background:#fff;padding:12px;text-align:center;font-size:22px;font-weight:bold;position:relative}
.badge{position:absolute;right:10px;top:10px;background:#ff9800;color:#fff;padding:4px 10px;border-radius:15px;font-size:12px}
#subWhatsapp{position:absolute;right:10px;top:38px}
#subWhatsapp button{background:#25D366;color:#fff;border:none;padding:4px 8px;border-radius:10px;font-size:11px}
button,input,textarea{width:100%;padding:12px;margin-top:8px;font-size:16px}
button{border:none;border-radius:6px}
.blue{background:#2196f3;color:#fff}
.green{background:#4caf50;color:#fff}
.red{background:#f44336;color:#fff}
.grey{background:#9e9e9e;color:#fff}
.month-nav{display:flex;justify-content:space-between;padding:10px;background:#eee}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px}
.day{background:#ddd;padding:12px;border-radius:6px;text-align:center;cursor:pointer}
.day.red{background:#e53935;color:#fff}
.day.green{background:#43a047;color:#fff}
.day.blue{background:#1e88e5;color:#fff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999}
.modal-box{background:#fff;margin:5% auto;padding:15px;width:90%;max-height:85%;overflow:auto}
</style>
</head>

<body>

<!-- LOCK SCREEN -->
<div id="lockScreen" class="center">
 <div class="box">
  <h3>Milk Diary ‚Äì Locked</h3>
  <input id="unlockPwd" placeholder="Enter Password">
  <button class="blue" onclick="unlockApp()">Unlock</button>
  <hr>
  <button style="background:#25D366;color:white;font-size:14px" onclick="openTrialWhatsapp()">
   Click here & send<br>(You will get Trial password)
  </button>
 </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">

 <div class="header">
  Milk Diary
  <div id="statusBadge" class="badge"></div>
  <div id="subWhatsapp">
    <button onclick="openSubWhatsapp()">üìû Get 1 Year Subscription</button>
  </div>
 </div>

 <div class="month-nav">
  <button onclick="changeMonth(-1)">‚¨ÖÔ∏è</button>
  <b id="monthTitle"></b>
  <button onclick="changeMonth(1)">‚û°Ô∏è</button>
 </div>

 <div class="calendar" id="calendar"></div>

 <div style="padding:15px">
  <button class="blue" onclick="openAdmin()">Admin Settings</button>

  <input id="notQty" placeholder="Not Supplied Qty">
  <button class="red" onclick="saveNot()">Save / Update Not Supplied</button>

  <input id="extraQty" placeholder="Extra Milk Qty">
  <button class="green" onclick="saveExtra()">Save / Update Extra Milk</button>

  <hr>
  <b>Customer Period Bill</b>
  <input id="fromDate" readonly onclick="setMode('from')" placeholder="From Date">
  <input id="toDate" readonly onclick="setMode('to')" placeholder="To Date">
  <button class="blue" onclick="viewPeriodBill()">Preview Period Bill</button>

  <hr>
  <button class="blue" onclick="viewMonthBill()">View Final Bill</button>

  <button class="green" onclick="openDetailedDatePicker()">
   Extra Supplied & Not Supplied Milk Report
  </button>
 </div>
</div>

<!-- ADMIN -->
<div id="adminModal" class="modal">
 <div class="modal-box">
  <h3>Admin Settings</h3>
  <input id="custPlot" placeholder="Door No">
  <textarea id="custAddr" placeholder="Address"></textarea>
  <input id="dailyQty" placeholder="Daily Milk Qty">
  <input id="rateInput" placeholder="Milk Rate ‚Çπ">
  <input id="serviceInput" placeholder="Service Charge ‚Çπ">
  <input id="milkmanInput" placeholder="Milkman WhatsApp Number">
  <button class="green" onclick="saveAdmin()">Save</button>
 </div>
</div>

<!-- BILL -->
<div id="billModal" class="modal">
 <div class="modal-box">
  <pre id="billPreview"></pre>
  <button class="green" onclick="sendToMilkman()">Send to Milkman WhatsApp</button>
  <button class="grey" onclick="billModal.style.display='none'">Back</button>
 </div>
</div>

<!-- DATE PICKER -->
<div id="datePickerModal" class="modal">
 <div class="modal-box">
  <div class="month-nav">
   <button onclick="changePickerMonth(-1)">‚¨ÖÔ∏è</button>
   <b id="pickerMonthTitle"></b>
   <button onclick="changePickerMonth(1)">‚û°Ô∏è</button>
  </div>
  <div class="calendar" id="pickerCalendar"></div>
 </div>
</div>

<script>
const REGISTRY_URL="data/registry.json";
const ADMIN_PHONE="917200893968";

/* DEVICE ID */
function getDeviceId(){
 let id=localStorage.getItem("MY_DEVICE_ID");
 if(!id){
  id="DEV-"+Math.random().toString(36).substr(2,12);
  localStorage.setItem("MY_DEVICE_ID",id);
 }
 return id;
}

/* WHATSAPP */
function openTrialWhatsapp(){
 let msg=`Hello,\nI need Trial Unlock Password.\n\nMy Device ID:\n${getDeviceId()}`;
 window.open("https://wa.me/"+ADMIN_PHONE+"?text="+encodeURIComponent(msg));
}
function openSubWhatsapp(){
 window.open("https://wa.me/"+ADMIN_PHONE+"?text=Need 1 Year Subscription Password");
}

/* UNLOCK */
async function unlockApp(){
 let pwd=unlockPwd.value.trim();
 let registry=await fetch(REGISTRY_URL+"?t="+Date.now()).then(r=>r.json());
 if(!registry[pwd]) return alert("Invalid Password");

 let record=registry[pwd];
 let myDevice=getDeviceId();

 if(record.used===true && record.device!==myDevice){
   alert("Password already used on another phone");
   return;
 }

 if(record.type==="paid"){
   localStorage.PAID_START=new Date().toISOString();
   localStorage.removeItem("TRIAL_START");
 }else{
   localStorage.TRIAL_START=new Date().toISOString();
 }

 startApp();
}

function lockExpired(msg){
 alert(msg+"\nPlease get Subscription Password");
 localStorage.removeItem("TRIAL_START");
 localStorage.removeItem("PAID_START");
 location.reload();
}

/* SUBSCRIPTION BADGE */
function checkSubscription(){
 const badge=statusBadge;
 const today=new Date();

 if(localStorage.PAID_START){
   let s=new Date(localStorage.PAID_START);
   let e=new Date(s); e.setDate(e.getDate()+365);
   let d=Math.ceil((e-today)/86400000);
   if(d<=0){lockExpired("Paid Subscription Expired");return;}
   badge.innerText="Paid - "+d+" Days Left";
   return;
 }

 if(localStorage.TRIAL_START){
   let s=new Date(localStorage.TRIAL_START);
   let e=new Date(s); e.setDate(e.getDate()+30);
   let d=Math.ceil((e-today)/86400000);
   if(d<=0){lockExpired("Trial Expired");return;}
   badge.innerText="Trial - "+d+" Days Left";
 }
}

function startApp(){
 lockScreen.style.display="none";
 app.style.display="block";
 loadAdmin();
 checkSubscription();
 renderCalendar();
}

/* AUTO LOAD IF ACTIVE */
window.onload=()=>{
 if(localStorage.TRIAL_START || localStorage.PAID_START){
   startApp();
 }
};

/* DATE FORMAT */
function key(d){return d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2);}
function fmt(d){return ("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+d.getFullYear();}

let data=JSON.parse(localStorage.MILK_DATA||"{}");
let current=new Date(),selectedDate=null,from=null,to=null;
let pickerDate=new Date(),pickingMode=null;

/* CALENDAR */
function renderCalendar(){
 monthTitle.innerText=current.toLocaleString("default",{month:"long",year:"numeric"});
 calendar.innerHTML="";
 let days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
 for(let i=1;i<=days;i++){
  let d=new Date(current.getFullYear(),current.getMonth(),i);
  let el=document.createElement("div");
  el.className="day";
  let k=key(d);
  if(data[k]){
   if(data[k].not && data[k].extra) el.classList.add("blue");
   else if(data[k].not) el.classList.add("red");
   else if(data[k].extra) el.classList.add("green");
  }
  el.innerText=i;
  el.onclick=()=>{
    selectedDate=d;
    let kk=key(d);
    notQty.value=(data[kk]?.not)||"";
    extraQty.value=(data[kk]?.extra)||"";
  };
  calendar.appendChild(el);
 }
}
function changeMonth(v){current.setMonth(current.getMonth()+v);renderCalendar();}

/* SAVE */
function saveNot(){
 if(!selectedDate)return;
 let k=key(selectedDate);
 data[k]=data[k]||{};
 data[k].not=parseInt(notQty.value)||0;
 localStorage.MILK_DATA=JSON.stringify(data);
 renderCalendar();
}
function saveExtra(){
 if(!selectedDate)return;
 let k=key(selectedDate);
 data[k]=data[k]||{};
 data[k].extra=parseInt(extraQty.value)||0;
 localStorage.MILK_DATA=JSON.stringify(data);
 renderCalendar();
}

/* ADMIN */
function openAdmin(){loadAdmin();adminModal.style.display="block";}
function saveAdmin(){
 localStorage.custPlot=custPlot.value;
 localStorage.custAddr=custAddr.value;
 localStorage.dailyQty=dailyQty.value;
 localStorage.rate=rateInput.value;
 localStorage.service=serviceInput.value;
 localStorage.milkman=milkmanInput.value;
 adminModal.style.display="none";
}
function loadAdmin(){
 custPlot.value=localStorage.custPlot||"";
 custAddr.value=localStorage.custAddr||"";
 dailyQty.value=localStorage.dailyQty||"";
 rateInput.value=localStorage.rate||"";
 serviceInput.value=localStorage.service||"";
 milkmanInput.value=localStorage.milkman||"";
}

/* DATE PICKER */
function setMode(m){pickingMode=m;openDatePicker();}
function openDatePicker(){pickerDate=new Date();renderPickerCalendar();datePickerModal.style.display="block";}
function changePickerMonth(v){pickerDate.setMonth(pickerDate.getMonth()+v);renderPickerCalendar();}
function renderPickerCalendar(){
 pickerMonthTitle.innerText=pickerDate.toLocaleString("default",{month:"long",year:"numeric"});
 pickerCalendar.innerHTML="";
 let days=new Date(pickerDate.getFullYear(),pickerDate.getMonth()+1,0).getDate();
 for(let i=1;i<=days;i++){
  let d=new Date(pickerDate.getFullYear(),pickerDate.getMonth(),i);
  let el=document.createElement("div");
  el.className="day"; el.innerText=i;
  el.onclick=()=>{
   if(pickingMode==="from"){from=d;fromDate.value=fmt(d);datePickerModal.style.display="none";}
   if(pickingMode==="to"){to=d;toDate.value=fmt(d);datePickerModal.style.display="none";}
   if(pickingMode==="detailFrom"){window.df=d;pickingMode="detailTo";}
   if(pickingMode==="detailTo"){datePickerModal.style.display="none";viewDetailedReportByDate(window.df,d);}
  };
  pickerCalendar.appendChild(el);
 }
}

/* MONTH + PERIOD BILL */
function viewMonthBill(){
 let s=new Date(current.getFullYear(),current.getMonth(),1);
 let e=new Date(current.getFullYear(),current.getMonth()+1,0);
 buildBill(s,e);
}
function viewPeriodBill(){
 if(!from||!to)return alert("Select From and To dates");
 buildBill(from,to);
}

<script>
function buildBill(s,e){
 let daily = +localStorage.dailyQty || 0;
 let rate  = +localStorage.rate || 0;
 let service = +localStorage.service || 0;

 let days = Math.floor((e - s) / 86400000) + 1;
 let base = daily * days;
 let extra = 0;
 let not = 0;

 let extraLines = "";
 let notLines = "";

 // Sort dates ascending
 let keys = Object.keys(data).sort();

 for(let k of keys){
   let d = new Date(k+"T00:00:00");
   if(d >= s && d <= e){
     if(data[k].extra){
       extra += data[k].extra;
       extraLines += fmt(d)+" : "+data[k].extra+" pkt\n";
     }
     if(data[k].not){
       not += data[k].not;
       notLines += fmt(d)+" : "+data[k].not+" pkt\n";
     }
   }
 }

 // If no entries
 if(extraLines === "") extraLines = "Nil\n";
 if(notLines === "") notLines = "Nil\n";

 let finalMilk = base + extra - not;
 let milkAmt = finalMilk * rate;
 let total = milkAmt + service;

 billPreview.innerText =
`MILK DIARY BILL

Plot / Door No:
${localStorage.custPlot || ""}

Address:
${localStorage.custAddr || ""}

Period:
${fmt(s)} to ${fmt(e)}

--------------------------------

Daily Milk:
${daily} pkt √ó ${days} days = ${base} pkt

Extra Milk:
${extraLines}
Total Extra: ${extra} pkt

Not Supplied:
${notLines}
Total Not Supplied: ${not} pkt

--------------------------------

Final Milk:
${base} + ${extra} - ${not} = ${finalMilk} pkt

Milk Rate:
‚Çπ${rate} per pkt

Milk Amount:
${finalMilk} √ó ‚Çπ${rate} = ‚Çπ${milkAmt}

Service Charge:
‚Çπ${service}

--------------------------------

GRAND TOTAL:
‚Çπ${total}

--------------------------------
Powered by Milk Diary - iniyan.talkies`;

 billModal.style.display="block";
}
</script>

/* ===== DETAILED REPORT BILL ===== */
function openDetailedDatePicker(){pickingMode="detailFrom";openDatePicker();}

function viewDetailedReportByDate(s,e){
 let extraLines="",notLines="";
 let extraTotal=0,notTotal=0;
 let keys=Object.keys(data).sort();

 for(let k of keys){
  let d=new Date(k+"T00:00:00");
  if(d>=s && d<=e){
   if(data[k].extra){extraLines+=fmt(d)+" : "+data[k].extra+" pkt\n";extraTotal+=data[k].extra;}
   if(data[k].not){notLines+=fmt(d)+" : "+data[k].not+" pkt\n";notTotal+=data[k].not;}
  }
 }

 if(extraLines==="") extraLines="Nil\n";
 if(notLines==="") notLines="Nil\n";

 billPreview.innerText=
`EXTRA & NOT SUPPLIED REPORT

Door No: ${localStorage.custPlot}
Address: ${localStorage.custAddr}
Period: ${fmt(s)} to ${fmt(e)}

EXTRA SUPPLIED:
${extraLines}
Total Extra: ${extraTotal} pkt

NOT SUPPLIED:
${notLines}
Total Not Supplied: ${notTotal} pkt

Powered by Milk Diary - iniyan.talkies`;

 billModal.style.display="block";
}

/* SEND TO WHATSAPP */
function sendToMilkman(){
 window.open("https://wa.me/91"+localStorage.milkman+"?text="+encodeURIComponent(billPreview.innerText));
}
</script>

</body>
</html>
